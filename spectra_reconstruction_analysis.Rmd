---
title: "Spectra reconstruction analysis"
author: "Ellie Dunstone"
date: "2023-02-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
library(tidyverse)
library(patchwork)
library(sigfit)
```


## Introduction

This is a script for analysing and exploring the quality of the spectrum reconstructions generated during signature extraction or fitting using sigfit, which can be installed from <https://github.com/kgori/sigfit>. Reconstructions of your samples under the 'model' you have calculated can be produced for all three modalities implemented in sigfit: reference signature fitting; de novo signature extraction; and combined fitting and extraction (FitExt). For further explanation, see the vignettes on the sigfit github, or my own 'sigfit_signature_analysis.Rmd' script that implements the sigfit package.

Sigfit allows us to examine how effectively the estimated signatures and/or exposures can reconstruct the original mutational catalogues by producing spectrum reconstruction plots with the 'plot_reconstruction' function. The underlying data can be accessed using the 'get_reconstructions' function, which provides the input data for this script. Some of the content of this script is adapted from the 'plot_reconstruction' function written by the authors of sigfit.


## Read in data

First, we read in the reconstruction data. Currently not clear which format will be best, so am reading in the .rds object output by get_reconstructions, and also the three individual tables that this object is comprised of.

```{r read in reconstruction data}
#read reconstructions table
recons <- as.matrix(read.csv("/Users/ed4/Documents/phd/chemo_project/BotSeq/panbody/panbody_20230106/extractions/20230217_panbody_2745_SF_COSMIC_fit_SBS96_reconstruction_analysis_test/ref_fit_hpd_0.01_reconstructions.csv"))[,-1]

#read reconstructions hpd table
recon_hpds <- as.data.frame(read.csv("/Users/ed4/Documents/phd/chemo_project/BotSeq/panbody/panbody_20230106/extractions/20230217_panbody_2745_SF_COSMIC_fit_SBS96_reconstruction_analysis_test/ref_fit_hpd_0.01_reconstructions_hpds.csv"))

#read reconstructions exposures table
recon_exposures <- as.data.frame(read.csv("/Users/ed4/Documents/phd/chemo_project/BotSeq/panbody/panbody_20230106/extractions/20230217_panbody_2745_SF_COSMIC_fit_SBS96_reconstruction_analysis_test/ref_fit_hpd_0.01_reconstructions_exposures.csv"))

#read in whole object as rds in case this is easier?
recons_all_obj <- readRDS("/Users/ed4/Documents/phd/chemo_project/BotSeq/panbody/panbody_20230106/extractions/20230217_panbody_2745_SF_COSMIC_fit_SBS96_reconstruction_analysis_test/ref_fit_hpd_0.01_reconstructions.rds")
```

We also need the original mutation catalogue used to generate the solution - this describes the sample spectra that we are trying to reconstruct using our model. This should be in the format used by sigfit (i.e. a numeric matrix
with one row per sample and one column per mutation type).

```{r read in mutation catalogue}
#read in catalogue in sigfit format
mutation_catalogue <- as.matrix(read.csv("/Users/ed4/Documents/phd/chemo_project/BotSeq/panbody/panbody_20230106/data/sigfit_mutation_catalogue.csv", row.names = 1))
colnames(mutation_catalogue) <- str_replace(colnames(mutation_catalogue), "\\.", ">") #Note: this line is only needed because exporting and reimporting the catalogue causes the "<" in the mutation types to be replaced with "." and I want to switch this back

#assign number of mut categories and samples
ncat <- ncol(mutation_catalogue)   # number of categories
nsamp <- nrow(mutation_catalogue)  # number of samples
```


## Calculating cosine similarities

We now want to assess the quality of the reconstruction for each sample. This is done by calculating the cosine similarity between the observed mutation spectrum, and the reconstructed spectrum generated under our model. 

```{r calculate cosine sim per sample}

#extract array from rds reconstructions object - 3 dimensions not preserved during export/inport (though this may be possible? idk)
reconstructions <- recons_all_obj$reconstructions

#need to make sure am matching correct samples definitely - again can check results


#get mutation counts from catalogue
counts <- mutation_catalogue

#init cosine sim dataframe
cossim_table <- as.data.frame(matrix(data = NA, nrow = nsamp, ncol = 2))
colnames(cossim_table) <- c("sample", "recon_cossim")

#calculate cosine sims and populate table
for (i in 1:nsamp) {
  cossim_table$sample[i] <- rownames(counts)[i]
  cossim_table$recon_cossim[i] <- cosine_sim(counts[i,], colSums(reconstructions[i, , ]))
}

#output table
write.csv(cossim_table, "/Users/ed4/Documents/phd/chemo_project/BotSeq/panbody/panbody_20230106/extractions/20230217_panbody_2745_SF_COSMIC_fit_SBS96_reconstruction_analysis_test/reconstruction_cossim_table.csv")

```

